{% extends "base.html" %}

{% block title %}FOCUS MODE - STUDYLOGIX{% endblock %}

{% block content %}
<!-- Nothing OS Pomodoro Interface -->
<div class="glass-card" style="margin-bottom: 32px;">
    <div style="padding: 20px; border-bottom: 1px solid var(--glass-border);">
        <h1 style="font-family: 'DotGothic16', monospace; font-size: 24px; color: var(--nothing-white); margin: 0; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-stopwatch" style="color: var(--nothing-red);"></i>
            FOCUS MODE
        </h1>
        <p style="color: var(--nothing-gray-400); margin: 8px 0 0 0; font-size: 13px;">
            DEEP WORK PROTOCOL • DISTRACTION ELIMINATION
        </p>
    </div>
    
    <div style="padding: 24px;">
        <div class="pomodoro-grid">
            <!-- Start Pomodoro Card -->
            <div class="pomodoro-card-small ambient-card">
                <h3 style="font-family: 'DotGothic16', monospace; color: var(--nothing-red); margin-bottom: 12px; display: flex; align-items: center; gap: 12px; font-size: 16px;">
                    <i class="fas fa-play"></i>
                    WORK SESSION
                </h3>
                <p style="color: var(--nothing-gray-300); margin-bottom: 16px; font-size: 13px; line-height: 1.5;">
                    25 MIN • FULL FOCUS
                </p>
                <button onclick="startPomodoro()" class="btn-nothing btn-nothing-primary" style="width: 100%;">
                    <i class="fas fa-rocket"></i>
                    START FOCUS
                </button>
            </div>
            
            <!-- Break Session Card -->
            <div class="pomodoro-card-small ambient-card" style="animation-delay: 0.1s;">
                <h3 style="font-family: 'DotGothic16', monospace; color: var(--nothing-green); margin-bottom: 12px; display: flex; align-items: center; gap: 12px; font-size: 16px;">
                    <i class="fas fa-pause"></i>
                    BREAK SESSION
                </h3>
                <p style="color: var(--nothing-gray-300); margin-bottom: 16px; font-size: 13px; line-height: 1.5;">
                    5 MIN • MENTAL RESET
                </p>
                <button onclick="startBreak()" class="btn-nothing" style="width: 100%;">
                    <i class="fas fa-coffee"></i>
                    START BREAK
                </button>
            </div>
            
            <!-- Custom Timer Card -->
            <div class="pomodoro-card-small ambient-card" style="animation-delay: 0.2s;">
                <h3 style="font-family: 'DotGothic16', monospace; color: var(--nothing-blue); margin-bottom: 12px; display: flex; align-items: center; gap: 12px; font-size: 16px;">
                    <i class="fas fa-cog"></i>
                    CUSTOM TIMER
                </h3>
                <div style="margin-bottom: 12px;">
                    <input type="number" id="customMinutes" class="form-control-nothing" placeholder="MINUTES" min="1" max="120">
                </div>
                <button onclick="startCustomTimer()" class="btn-nothing" style="width: 100%;">
                    <i class="fas fa-timer"></i>
                    CUSTOM SESSION
                </button>
            </div>
        </div>
        
        <!-- Session Stats -->
        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--glass-border);">
            <h3 style="font-family: 'DotGothic16', monospace; color: var(--nothing-white); margin-bottom: 16px; text-align: center; font-size: 16px;">
                SESSION STATS
            </h3>
            <div class="stats-grid-mini">
                <div style="text-align: center;">
                    <div class="stats-value-nothing" style="font-size: 1.5rem; color: var(--nothing-cyan);">
                        {% if pomodoro_stats %}{{ pomodoro_stats.total_sessions }}{% else %}0{% endif %}
                    </div>
                    <div class="stats-label-nothing" style="font-size: 11px;">SESSIONS</div>
                </div>
                <div style="text-align: center;">
                    <div class="stats-value-nothing" style="font-size: 1.5rem; color: var(--nothing-green);">
                        {% if pomodoro_stats %}{{ pomodoro_stats.total_focus_time }}{% else %}0{% endif %}
                    </div>
                    <div class="stats-label-nothing" style="font-size: 11px;">MINUTES</div>
                </div>
                <div style="text-align: center;">
                    <div class="stats-value-nothing" style="font-size: 1.5rem; color: var(--nothing-orange);">
                        {% if pomodoro_stats %}{{ pomodoro_stats.today_sessions }}{% else %}0{% endif %}
                    </div>
                    <div class="stats-label-nothing" style="font-size: 11px;">TODAY</div>
                </div>
                <div style="text-align: center;">
                    <div class="stats-value-nothing" style="font-size: 1.5rem; color: var(--nothing-purple);">
                        {% if pomodoro_stats %}{{ pomodoro_stats.average_session_length }}{% else %}0{% endif %}
                    </div>
                    <div class="stats-label-nothing" style="font-size: 11px;">AVG</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Nothing OS Floating Orb Timer -->
<div class="focus-mode-overlay" id="focusOverlay"></div>
<div class="pomodoro-orb" id="pomodoroOrb">
    <div class="pomodoro-progress" id="progressRing"></div>
    <div class="pomodoro-time-display" id="timeDisplay">25:00</div>
    <div class="pomodoro-label" id="sessionLabel">FOCUS SESSION</div>
    <div class="pomodoro-controls">
        <button class="btn-nothing" onclick="pauseTimer()" id="pauseBtn">
            <i class="fas fa-pause"></i>
        </button>
        <button class="btn-nothing btn-nothing-danger" onclick="stopTimer()" id="stopBtn">
            <i class="fas fa-stop"></i>
        </button>
    </div>
</div>

<!-- Audio for notifications -->
<audio id="notificationSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbByRrZE2MXPKBqLOpRSZXeD1jgNP8hAL0fKnMjdoFfzHWFLyHj7bCiTv1hZJvOHt+fJPJ6sHuL+KjQFWJ8LT1gNB4Z4Qk8Hb5jLqHpKStnK8mZHldnC6pnXwdBnf4VCr0yWTrZZnSJ7rXsLaKlMTyTHlJJ3TvKRn1GhKo1+1H8UE1wjJYCyPeF8SdM/qvs+Q5P/XC2hOJ9nM6Gx8rZL4y9jA+FtQ1TUwmvJJ9ljX9nO3OMSLPQlOCzMHFnGF8H9YMzYHqaHYL1hQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYFhQ7r7SYAAA=" type="audio/wav">
</audio>

<!-- Custom Confirmation Modal -->
<div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 99999; backdrop-filter: blur(10px); align-items: center; justify-content: center;">
    <div class="glass-card" style="max-width: 500px; width: 90%; padding: 32px; animation: float 6s ease-in-out infinite;">
        <div style="margin-bottom: 24px;">
            <h3 id="confirmTitle" style="font-family: 'DotGothic16', monospace; color: var(--nothing-white); margin: 0 0 12px 0; font-size: 20px;"></h3>
            <p id="confirmMessage" style="color: var(--nothing-gray-400); margin: 0; font-size: 14px; line-height: 1.6;"></p>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button id="confirmCancel" class="btn-nothing" onclick="closeConfirmModal(false)">
                <i class="fas fa-times"></i>
                CANCEL
            </button>
            <button id="confirmOk" class="btn-nothing btn-nothing-primary" onclick="closeConfirmModal(true)">
                <i class="fas fa-check"></i>
                CONFIRM
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Custom Confirm Modal
let confirmResolve;

function showConfirm(title, message) {
    return new Promise((resolve) => {
        confirmResolve = resolve;
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmModal').style.display = 'flex';
    });
}

function closeConfirmModal(result) {
    document.getElementById('confirmModal').style.display = 'none';
    if (confirmResolve) {
        confirmResolve(result);
        confirmResolve = null;
    }
}

// Nothing OS Pomodoro Timer System
let timerInterval;
let isRunning = false;
let isPaused = false;
let currentTime = 0;
let totalTime = 0;
let isBreakTime = false;
let currentSessionId = null;

function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function updateProgress(current, total) {
    const percentage = ((total - current) / total) * 360;
    const progressRing = document.getElementById('progressRing');
    progressRing.style.setProperty('--progress-angle', `${percentage}deg`);
}

function playNotification() {
    const audio = document.getElementById('notificationSound');
    audio.play().catch(e => console.log('Audio play failed:', e));
    
    // System notification if available
    if ('Notification' in window && Notification.permission === 'granted') {
        const title = isBreakTime ? 'BREAK COMPLETE' : 'FOCUS SESSION COMPLETE';
        const body = isBreakTime ? 'Ready for next focus session!' : 'Time for a well-deserved break!';
        new Notification(title, {
            body: body,
            icon: '/static/favicon.ico',
            tag: 'pomodoro'
        });
    }
}

function enterFocusMode() {
    document.getElementById('focusOverlay').classList.add('active');
    document.getElementById('pomodoroOrb').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function exitFocusMode() {
    document.getElementById('focusOverlay').classList.remove('active');
    document.getElementById('pomodoroOrb').classList.remove('active');
    document.body.style.overflow = '';
    isRunning = false;
    isPaused = false;
    currentSessionId = null;
}

function startPomodoro() {
    startTimer(25, false, 'FOCUS SESSION');
}

function startBreak() {
    startTimer(5, true, 'BREAK TIME');
}

function startCustomTimer() {
    const minutes = parseInt(document.getElementById('customMinutes').value);
    if (minutes && minutes > 0) {
        startTimer(minutes, false, 'CUSTOM SESSION');
    } else {
        alert('PLEASE ENTER VALID MINUTES (1-120)');
    }
}

function startTimer(minutes, breakMode, label, skipBackendCall = false) {
    if (isRunning) return;
    
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    isBreakTime = breakMode;
    totalTime = minutes * 60;
    currentTime = totalTime;
    isRunning = true;
    isPaused = false;
    
    document.getElementById('timeDisplay').textContent = formatTime(currentTime);
    document.getElementById('sessionLabel').textContent = label;
    
    enterFocusMode();
    
    // Start session in backend if not break and not skipping
    if (!isBreakTime && !skipBackendCall) {
        fetch('/api/pomodoro/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                subject: label,
                duration: minutes,
                session_type: 'work'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentSessionId = data.session_id;
                console.log('Session started:', currentSessionId);
            }
        })
        .catch(error => console.error('Error starting session:', error));
    }
    
    timerInterval = setInterval(() => {
        if (!isPaused) {
            currentTime--;
            document.getElementById('timeDisplay').textContent = formatTime(currentTime);
            updateProgress(currentTime, totalTime);
            
            // Update live timer status every 10 seconds
            if (!isBreakTime && currentSessionId && currentTime % 10 === 0) {
                updateLiveTimer();
            }
            
            if (currentTime <= 0) {
                timerComplete();
            }
        }
    }, 1000);
}

function updateLiveTimer() {
    // Send timer status to backend for friends to see
    if (!currentSessionId) return;
    
    fetch('/api/timer/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: currentSessionId,
            subject: currentSubject || 'STUDY',
            duration_minutes: Math.floor(totalTime / 60),
            time_remaining: currentTime,
            is_break: isBreakTime
        })
    }).catch(error => console.error('Error updating live timer:', error));
}

function timerComplete() {
    clearInterval(timerInterval);
    playNotification();
    
    // Complete session in backend if not break
    if (!isBreakTime && currentSessionId) {
        const elapsedSeconds = totalTime - currentTime;
        const elapsedMinutes = Math.max(1, Math.ceil(elapsedSeconds / 60));
        
        console.log(`DEBUG - Timer completed. Elapsed: ${elapsedSeconds}s, Minutes: ${elapsedMinutes}`);
        
        fetch('/api/pomodoro/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                session_id: currentSessionId, 
                duration: elapsedMinutes 
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Session completed:', data);
            setTimeout(async () => {
                exitFocusMode();
                // Auto-suggest break
                const startBreakNow = await showConfirm('FOCUS SESSION COMPLETE!', 'Start a 5-minute break?');
                if (startBreakNow) {
                    setTimeout(() => startBreak(), 1000);
                }
            }, 2000);
        })
        .catch(error => {
            console.error('Error completing session:', error);
            setTimeout(exitFocusMode, 2000);
        });
    } else {
        setTimeout(async () => {
            exitFocusMode();
            if (isBreakTime) {
                const startFocus = await showConfirm('BREAK COMPLETE!', 'Ready for another focus session?');
                if (startFocus) {
                    setTimeout(() => startPomodoro(), 1000);
                }
            }
        }, 2000);
    }
}

function pauseTimer() {
    isPaused = !isPaused;
    const pauseBtn = document.getElementById('pauseBtn');
    const icon = pauseBtn.querySelector('i');
    
    if (isPaused) {
        icon.className = 'fas fa-play';
        pauseBtn.style.borderColor = 'var(--nothing-green)';
        pauseBtn.style.color = 'var(--nothing-green)';
    } else {
        icon.className = 'fas fa-pause';
        pauseBtn.style.borderColor = 'var(--nothing-gray-400)';
        pauseBtn.style.color = 'var(--nothing-white)';
    }
}

async function stopTimer() {
    const confirmStop = await showConfirm('STOP TIMER', 'Are you sure you want to stop the timer? This will save your current progress.');
    if (confirmStop) {
        clearInterval(timerInterval);
        isRunning = false;
        
        // Calculate elapsed time and save as a completed session
        const elapsedSeconds = totalTime - currentTime;
        const elapsedMinutes = Math.max(1, Math.ceil(elapsedSeconds / 60));
        
        console.log(`DEBUG - Timer stopped. Elapsed: ${elapsedSeconds}s, Minutes: ${elapsedMinutes}`);
        console.log(`DEBUG - Current Session ID: ${currentSessionId}, Is Break: ${isBreakTime}`);
        
        // Complete the session with actual elapsed time
        if (currentSessionId && !isBreakTime) {
            console.log('DEBUG - Calling complete API...');
            fetch('/api/pomodoro/complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    session_id: currentSessionId, 
                    duration: elapsedMinutes 
                })
            })
            .then(response => {
                console.log('DEBUG - Complete API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('DEBUG - Stop complete response:', data);
                exitFocusMode();
            })
            .catch(error => {
                console.error('DEBUG - Error completing session:', error);
                exitFocusMode();
            });
        } else {
            console.log('DEBUG - Cancelling session (break time or no session ID)');
            // If it's break time or no session ID, just cancel
            if (currentSessionId) {
                fetch('/api/pomodoro/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_id: currentSessionId })
                })
                .then(() => exitFocusMode())
                .catch(() => exitFocusMode());
            } else {
                exitFocusMode();
            }
        }
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (isRunning) {
        if (e.code === 'Space') {
            e.preventDefault();
            pauseTimer();
        } else if (e.code === 'Escape') {
            e.preventDefault();
            stopTimer();
        }
    } else {
        if (e.code === 'KeyF') {
            e.preventDefault();
            startPomodoro();
        } else if (e.code === 'KeyB') {
            e.preventDefault();
            startBreak();
        }
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('FOCUS MODE INITIALIZED');
    console.log('SHORTCUTS: F=Focus, B=Break, SPACE=Pause, ESC=Stop');
    
    // Check for autostart from quick start modal
    const urlParams = new URLSearchParams(window.location.search);
    const autostart = urlParams.get('autostart');
    const duration = urlParams.get('duration');
    
    if (autostart === 'true') {
        // Get session info from sessionStorage
        const sessionId = sessionStorage.getItem('activeSessionId');
        const sessionDuration = sessionStorage.getItem('activeSessionDuration');
        const sessionSubject = sessionStorage.getItem('activeSessionSubject');
        
        console.log('Autostart detected:', { sessionId, sessionDuration, sessionSubject });
        
        if (sessionId && sessionDuration && sessionSubject) {
            // Clear the sessionStorage
            sessionStorage.removeItem('activeSessionId');
            sessionStorage.removeItem('activeSessionDuration');
            sessionStorage.removeItem('activeSessionSubject');
            
            // Set current session
            currentSessionId = sessionId;
            currentSubject = sessionSubject;
            
            // Start the timer with custom duration (skip backend call since session already created)
            const durationMins = parseInt(sessionDuration) || 25;
            startTimer(durationMins, false, sessionSubject.toUpperCase(), true);
        }
    }
});
</script>
{% endblock %}
